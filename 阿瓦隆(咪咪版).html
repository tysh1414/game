<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜¿ç“¦éš† - ç¶²é ç‰ˆ</title>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #1a1a1a; color: #e0e0e0; text-align: center; margin: 0; padding: 20px; }
        h1 { color: #d4af37; text-shadow: 2px 2px 4px #000; margin-top: 0; }
        .container { position: relative; max-width: 600px; margin: 0 auto; background: #2d2d2d; padding: 20px; border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .btn { background-color: #4a69bd; color: white; border: none; padding: 15px 20px; font-size: 16px; margin: 10px 5px; border-radius: 8px; cursor: pointer; width: 80%; max-width: 300px; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-red { background-color: #e55039; }
        .btn-green { background-color: #78e08f; color: #1a1a1a; }
        .btn-gold { background-color: #f0932b; color: #1a1a1a; font-weight: bold; border: 2px solid #d4af37; }
        
        /* é‡ç½®æŒ‰éˆ• (å³ä¸Šè§’) */
        .reset-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: 1px solid #777;
            color: #aaa;
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 5px;
            cursor: pointer;
        }
        .reset-btn:hover { background: #444; color: white; border-color: white; }

        .hidden { display: none; }
        .role-card { border: 2px solid #d4af37; padding: 20px; margin: 20px 0; background: #333; border-radius: 10px; }
        .info-text { color: #f6b93b; font-weight: bold; }
        .good { color: #82ccdd; }
        .evil { color: #ff6b6b; }
        
        input[type="text"], input[type="number"] { padding: 10px; font-size: 16px; width: 70%; margin-bottom: 10px; border-radius: 5px; border: 1px solid #555; background: #444; color: white; }
        
        .scoreboard { display: flex; justify-content: space-around; margin-bottom: 20px; }
        .score-box { padding: 10px; border-radius: 5px; width: 40%; font-weight: bold; }
        .score-blue { background: #0c2461; border: 2px solid #4a69bd; }
        .score-red { background: #6a040f; border: 2px solid #e55039; }
        
        .player-list { text-align: left; padding: 10px; background: #222; margin: 10px 0; border-radius: 5px; max-height: 300px; overflow-y: auto; }
        .list-item { border-bottom: 1px solid #444; padding: 8px; }
    </style>
</head>
<body>

<div class="container">
    <button class="reset-btn" onclick="confirmReset()">â†» é‡ç½®éŠæˆ²</button>

    <h1>âš”ï¸ é˜¿ç“¦éš†</h1>
    
    <div id="setup-phase">
        <p>è«‹è¼¸å…¥ç©å®¶äººæ•¸ (5-10äºº)</p>
        <input type="number" id="num-players" min="5" max="10" value="5">
        <br>
        <button class="btn" onclick="initPlayersInput()">ä¸‹ä¸€æ­¥ï¼šè¼¸å…¥åå­—</button>
    </div>

    <div id="names-phase" class="hidden">
        <div id="name-inputs"></div>
        <button class="btn" onclick="startGame(false)">é–‹å§‹åˆ†é…è§’è‰²</button>
    </div>

    <div id="reveal-phase" class="hidden">
        <h2 id="reveal-title">æº–å‚™æŸ¥çœ‹èº«åˆ†</h2>
        <p>è«‹å°‡è£ç½®äº¤çµ¦ <span id="current-player-name" class="info-text"></span></p>
        <div id="reveal-card" class="role-card hidden">
            <h3>ä½ çš„èº«åˆ†æ˜¯ï¼š</h3>
            <h2 id="role-name"></h2>
            <p id="role-info"></p>
        </div>
        <button id="reveal-btn" class="btn" onclick="showRole()">ğŸ‘ï¸ é»æ“ŠæŸ¥çœ‹ (ç¢ºèªç„¡æ—äºº)</button>
        <button id="next-player-btn" class="btn hidden" onclick="nextPlayerReveal()">éš±è—ä¸¦å‚³çµ¦ä¸‹ä¸€ä½</button>
    </div>

    <div id="game-phase" class="hidden">
        <div class="scoreboard">
            <div class="score-box score-blue">æ­£ç¾©æ–¹å‹: <span id="blue-score">0</span></div>
            <div class="score-box score-red">é‚ªæƒ¡æ–¹å‹: <span id="red-score">0</span></div>
        </div>
        <p>ç¬¬ <span id="round-num" class="info-text">1</span> å›åˆ | éœ€ <span id="mission-req" class="info-text">2</span> äºº</p>
        <p>é€£çºŒæŠ•ç¥¨å¤±æ•—: <span id="vote-fails">0</span>/5</p>
        <hr>
        <h3>ğŸ‘‘ ç¾ä»»é ˜è¢–ï¼š<span id="current-leader" style="color:#d4af37"></span></h3>
        <p>è«‹é ˜è¢–èˆ‡å¤§å®¶è¨è«–ï¼Œä¸¦åœ¨æ­¤æ“ä½œçµæœï¼š</p>
        
        <div id="action-area">
            <button class="btn" onclick="showVoting()">é€²å…¥æŠ•ç¥¨éšæ®µ</button>
        </div>
    </div>

    <div id="voting-phase" class="hidden">
        <h3>âœ‹ å…¨å“¡æŠ•ç¥¨</h3>
        <p>è«‹å¤§å®¶èˆ‰æ‰‹æŠ•ç¥¨è¡¨æ±ºéšŠä¼ã€‚</p>
        <p>æŠ•ç¥¨çµæœæ˜¯ï¼Ÿ</p>
        <button class="btn btn-green" onclick="processVote(true)">âœ… é€šé (å¤šæ•¸è´Šæˆ)</button>
        <button class="btn btn-red" onclick="processVote(false)">âŒ å¦æ±º (å¤šæ•¸åå°/å¹³ç¥¨)</button>
    </div>

    <div id="mission-phase" class="hidden">
        <h3>ğŸš€ åŸ·è¡Œä»»å‹™</h3>
        <p>éšŠä¼å·²æ´¾å‡ºï¼è«‹å°‡è£ç½®äº¤çµ¦å‡ºä»»å‹™çš„ç©å®¶ã€‚</p>
        <p>ç•¶å‰æ“ä½œè€…ï¼š<span id="mission-player" class="info-text"></span></p>
        
        <div id="mission-actions" class="hidden">
            <button class="btn btn-green" onclick="submitMissionCard(true)">ä»»å‹™æˆåŠŸ</button>
            <button class="btn btn-red" onclick="submitMissionCard(false)">ä»»å‹™å¤±æ•— (åƒ…å£äººå¯é¸)</button>
        </div>
        <button id="mission-start-btn" class="btn" onclick="startMissionAction()">æˆ‘æ˜¯æœ¬äººï¼Œé–‹å§‹å‡ºç‰Œ</button>
    </div>
    
    <div id="result-phase" class="hidden">
        <h2 id="result-title"></h2>
        <p id="result-desc"></p>
        <button class="btn" onclick="nextRound()">é€²å…¥ä¸‹ä¸€å›åˆ</button>
    </div>
    
    <div id="game-over-phase" class="hidden">
        <h1 id="winner-text"></h1>
        <p id="end-game-msg" style="white-space: pre-line; font-size: 18px; margin: 20px;"></p>
        
        <button id="btn-reveal-all" class="btn btn-gold" onclick="revealAllRoles()">ğŸ”“ æ­æ›‰æ‰€æœ‰èº«åˆ†</button>
        
        <div id="all-roles-reveal" class="player-list hidden"></div>
        
        <div style="margin-top: 30px; border-top: 1px solid #555; padding-top: 10px;">
            <button class="btn" onclick="startGame(true)">ğŸ”„ ä¿ç•™ç©å®¶ï¼Œå†ä¾†ä¸€å±€</button>
            <button class="btn btn-red" onclick="location.reload()">ğŸšª é›¢é–‹ / é‡æ–°è¨­å®š</button>
        </div>
    </div>

</div>

<script>
    // éŠæˆ²è®Šæ•¸
    let players = [];
    let playerNames = []; // å„²å­˜åå­—ä»¥ä¾¿é‡é–‹å±€
    let numPlayers = 0;
    let currentRound = 0; 
    let blueWins = 0;
    let redWins = 0;
    let voteFailCount = 0;
    let leaderIndex = 0;
    let missionTempResults = [];
    let revealIndex = 0;
    
    // é…ç½®è¡¨ (æ¨™æº–è¦å‰‡)
    const missionConfig = {
        5: [2, 3, 2, 3, 3],
        6: [2, 3, 4, 3, 4],
        7: [2, 3, 3, 4, 4], // R4éœ€2å¤±æ•—
        8: [3, 4, 4, 5, 5],
        9: [3, 4, 4, 5, 5],
        10: [3, 4, 4, 5, 5]
    };

    // å…¨å±€é‡ç½®
    function confirmReset() {
        if(confirm("ç¢ºå®šè¦é‡ç½®éŠæˆ²å—ï¼Ÿç•¶å‰é€²åº¦å°‡æœƒéºå¤±ã€‚")) {
            location.reload();
        }
    }

    // åˆå§‹åŒ–è¼¸å…¥æ¡†
    function initPlayersInput() {
        numPlayers = parseInt(document.getElementById("num-players").value);
        if(numPlayers < 5 || numPlayers > 10) return alert("äººæ•¸é ˆç‚º 5-10 äºº");
        
        let html = "";
        for(let i=0; i<numPlayers; i++) {
            html += `<input type="text" id="pname-${i}" placeholder="ç©å®¶ ${i+1} åç¨±" value="ç©å®¶${i+1}"><br>`;
        }
        document.getElementById("name-inputs").innerHTML = html;
        switchPhase("names-phase");
    }

    // é–‹å§‹éŠæˆ² (isRestart: æ˜¯å¦ç‚ºä¿ç•™ç©å®¶çš„é‡é–‹å±€)
    function startGame(isRestart) {
        if (!isRestart) {
            playerNames = [];
            for(let i=0; i<numPlayers; i++) {
                let val = document.getElementById(`pname-${i}`).value;
                playerNames.push(val || `ç©å®¶${i+1}`);
            }
        }
        
        currentRound = 0;
        blueWins = 0;
        redWins = 0;
        voteFailCount = 0;
        
        // è§’è‰²åˆ†é…é‚è¼¯ (5-10äºº)
        let deck = [];
        let goodCount = 0;
        
        if (numPlayers == 5) { deck = ["æ¢…æ—", "æ´¾è¥¿ç¶­çˆ¾", "å¿ è‡£", "åˆºå®¢", "è«ç”˜å¨œ"]; goodCount = 3; }
        else if (numPlayers == 6) { deck = ["æ¢…æ—", "æ´¾è¥¿ç¶­çˆ¾", "å¿ è‡£", "å¿ è‡£", "åˆºå®¢", "è«ç”˜å¨œ"]; goodCount = 4; }
        else if (numPlayers == 7) { deck = ["æ¢…æ—", "æ´¾è¥¿ç¶­çˆ¾", "å¿ è‡£", "å¿ è‡£", "åˆºå®¢", "è«ç”˜å¨œ", "å¥§ä¼¯å€«"]; goodCount = 4; }
        else {
             let base = ["æ¢…æ—", "æ´¾è¥¿ç¶­çˆ¾", "åˆºå®¢", "è«ç”˜å¨œ"];
             let totalGood = (numPlayers >= 8) ? 5 : (numPlayers >= 9 ? 6 : 6); 
             if(numPlayers==9) totalGood=6;
             if(numPlayers==10) totalGood=6;
             
             let totalEvil = numPlayers - totalGood;
             for(let k=0; k < totalGood-2; k++) base.push("å¿ è‡£");
             for(let k=0; k < totalEvil-2; k++) base.push("çˆªç‰™");
             deck = base;
             if (numPlayers === 10 && deck.includes("çˆªç‰™")) {
                 deck[deck.indexOf("çˆªç‰™")] = "å¥§ä¼¯å€«";
             }
        }
        
        deck.sort(() => Math.random() - 0.5);
        
        players = [];
        for(let i=0; i<numPlayers; i++) {
            players.push({ name: playerNames[i], role: deck[i] });
        }
        
        leaderIndex = Math.floor(Math.random() * numPlayers);
        revealIndex = 0;
        switchPhase("reveal-phase");
        updateRevealUI();
    }

    // --- UI åˆ‡æ›èˆ‡é‚è¼¯ ---

    function updateRevealUI() {
        if(revealIndex >= players.length) {
            switchPhase("game-phase");
            updateGameUI();
            return;
        }
        document.getElementById("current-player-name").innerText = players[revealIndex].name;
        document.getElementById("reveal-card").classList.add("hidden");
        document.getElementById("reveal-btn").classList.remove("hidden");
        document.getElementById("next-player-btn").classList.add("hidden");
    }

    function showRole() {
        const p = players[revealIndex];
        document.getElementById("role-name").innerText = p.role;
        
        const evilRoles = ["åˆºå®¢", "è«ç”˜å¨œ", "çˆªç‰™", "è«å¾·é›·å¾·", "å¥§ä¼¯å€«"];
        const isEvilFaction = evilRoles.includes(p.role);
        
        let info = "";
        
        if (p.role === "æ¢…æ—") {
            let evils = players.filter(x => evilRoles.includes(x.role) && x.role !== "è«å¾·é›·å¾·").map(x => x.name);
            info = "ä½ çœ‹è¦‹çš„å£äººæœ‰ï¼š " + evils.join(", ");
            
        } else if (p.role === "æ´¾è¥¿ç¶­çˆ¾") {
            let targets = players.filter(x => ["æ¢…æ—", "è«ç”˜å¨œ"].includes(x.role)).map(x => x.name);
            info = "ä½ çœ‹è¦‹çš„æ¢…æ—èˆ‡è«ç”˜å¨œæ˜¯ï¼š " + targets.join(", ");
            
        } else if (p.role === "å¥§ä¼¯å€«") {
            info = "ä½ æ˜¯é‚ªæƒ¡æ–¹ï¼Œä½ ä¸çŸ¥é“å…¶ä»–é‚ªæƒ¡æ–¹æœ‰èª°ï¼Œä»–å€‘ä¹Ÿä¸çŸ¥é“ä½ ï¼Œä½ æ˜¯å­¤å…’ã€‚";
            
        } else if (isEvilFaction) {
            let teammates = players.filter(x => evilRoles.includes(x.role) && x.role !== "å¥§ä¼¯å€«" && x.name !== p.name).map(x => x.name);
            info = "ä½ çš„é‚ªæƒ¡éšŠå‹æ˜¯ï¼š " + teammates.join(", ");
            
        } else {
            info = "ä½ æ˜¯æ­£ç¾©çš„å¤¥ä¼´ï¼Œè«‹çœå¤§çœ¼ç›å°‹æ‰¾çœŸç›¸ã€‚";
        }
        
        document.getElementById("role-info").innerText = info;
        
        const title = document.getElementById("role-name");
        if(isEvilFaction) {
            title.className = "evil";
        } else {
            title.className = "good";
        }

        document.getElementById("reveal-card").classList.remove("hidden");
        document.getElementById("reveal-btn").classList.add("hidden");
        document.getElementById("next-player-btn").classList.remove("hidden");
    }

    function nextPlayerReveal() {
        revealIndex++;
        updateRevealUI();
    }

    function updateGameUI() {
        document.getElementById("blue-score").innerText = blueWins;
        document.getElementById("red-score").innerText = redWins;
        document.getElementById("round-num").innerText = currentRound + 1;
        document.getElementById("mission-req").innerText = missionConfig[players.length][currentRound];
        document.getElementById("vote-fails").innerText = voteFailCount;
        document.getElementById("current-leader").innerText = players[leaderIndex].name;
    }

    function switchPhase(id) {
        const phases = ["setup-phase", "names-phase", "reveal-phase", "game-phase", "voting-phase", "mission-phase", "result-phase", "game-over-phase"];
        phases.forEach(p => document.getElementById(p).classList.add("hidden"));
        document.getElementById(id).classList.remove("hidden");
    }

    function showVoting() {
        switchPhase("voting-phase");
    }

    function processVote(isPass) {
        if (isPass) {
            alert("âœ… æè­°é€šéï¼æº–å‚™å‡ºä»»å‹™ï¼");
            voteFailCount = 0;
            startMissionPhase();
        } else {
            alert("âŒ æè­°è¢«å¦æ±ºï¼");
            voteFailCount++;
            leaderIndex = (leaderIndex + 1) % players.length;
            
            if(voteFailCount >= 5) {
                endGame("evil_vote", "é€£çºŒ 5 æ¬¡æè­°å¤±æ•—ã€‚");
            } else {
                switchPhase("game-phase");
                updateGameUI();
            }
        }
    }

    let missionMembersCount = 0;
    let currentMissionMemberIndex = 0;

    function startMissionPhase() {
        missionMembersCount = missionConfig[players.length][currentRound];
        missionTempResults = [];
        currentMissionMemberIndex = 0;
        updateMissionUI();
        switchPhase("mission-phase");
    }

    function updateMissionUI() {
        if(currentMissionMemberIndex < missionMembersCount) {
            document.getElementById("mission-player").innerText = `ç¬¬ ${currentMissionMemberIndex + 1} ä½éšŠå“¡`;
            document.getElementById("mission-actions").classList.add("hidden");
            document.getElementById("mission-start-btn").classList.remove("hidden");
        } else {
            calcMissionResult();
        }
    }

    function startMissionAction() {
        document.getElementById("mission-start-btn").classList.add("hidden");
        document.getElementById("mission-actions").classList.remove("hidden");
    }

    function submitMissionCard(isSuccess) {
        missionTempResults.push(isSuccess);
        currentMissionMemberIndex++;
        alert("å¡ç‰‡å·²é€å‡ºï¼è«‹äº¤çµ¦ä¸‹ä¸€ä½ï¼ˆæˆ–äº¤å›çµ¦ä¸»æŒäººï¼‰ã€‚");
        updateMissionUI();
    }

    function calcMissionResult() {
        let fails = missionTempResults.filter(x => x === false).length;
        let isFail = false;
        
        // 7äººä»¥ä¸Šç¬¬4å±€éœ€2å¼µ (index 3)
        if(players.length >= 7 && currentRound === 3) {
            isFail = fails >= 2;
        } else {
            isFail = fails >= 1;
        }

        let title = isFail ? "âŒ ä»»å‹™å¤±æ•—ï¼" : "ğŸ‰ ä»»å‹™æˆåŠŸï¼";
        let desc = isFail ? `å‡ºç¾äº† ${fails} å¼µå¤±æ•—å¡ï¼` : "æ‰€æœ‰äººéƒ½åŸ·è¡Œäº†ä»»å‹™æˆåŠŸã€‚";
        
        if(isFail) redWins++; else blueWins++;

        document.getElementById("result-title").innerText = title;
        document.getElementById("result-desc").innerText = desc;
        switchPhase("result-phase");
    }

    function nextRound() {
        if (blueWins >= 3) {
            endGame("assassin", "æ­£ç¾©æ–¹å®Œæˆäº† 3 å€‹ä»»å‹™ï¼");
        } else if (redWins >= 3) {
            endGame("evil_mission", "é‚ªæƒ¡æ–¹ä½¿ 3 å€‹ä»»å‹™å¤±æ•—ã€‚");
        } else {
            currentRound++;
            leaderIndex = (leaderIndex + 1) % players.length;
            switchPhase("game-phase");
            updateGameUI();
        }
    }

    // æ”¹å¯«çµæŸé‚è¼¯
    function endGame(type, reason) {
        switchPhase("game-over-phase");
        const h1 = document.getElementById("winner-text");
        const msgP = document.getElementById("end-game-msg");
        
        // é‡ç½®æ­æ›‰å€å¡Š
        document.getElementById("all-roles-reveal").innerHTML = "";
        document.getElementById("all-roles-reveal").classList.add("hidden");
        document.getElementById("btn-reveal-all").classList.remove("hidden");

        if (type === "assassin") {
            // æ­£ç¾©æ–¹ 3å‹ -> åˆºæ®ºéšæ®µ
            h1.innerText = "âš”ï¸ é€²å…¥åˆºæ®ºæ¢…æ—éšæ®µ";
            h1.style.color = "#d4af37"; // é‡‘è‰²
            msgP.innerText = reason + "\n\nè«‹åˆºå®¢å…¬é–‹èº«åˆ†ï¼Œä¸¦èˆ‡é‚ªæƒ¡æ–¹è¨è«–ã€‚\nè‹¥åˆºå®¢æŒ‡èªå‡ºæ¢…æ—ï¼Œé‚ªæƒ¡æ–¹åæ•—ç‚ºå‹ï¼\n\n(è¨è«–å®Œç•¢å¾Œï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•æ­æ›‰èº«åˆ†)";
        } else {
            // é‚ªæƒ¡æ–¹ç²å‹
            h1.innerText = "ğŸ”´ é‚ªæƒ¡æ–¹ç²å‹";
            h1.style.color = "#e55039";
            msgP.innerText = reason;
        }
    }

    // æ­æ›‰èº«åˆ†å‡½å¼
    function revealAllRoles() {
        let html = `<h3>èº«åˆ†æ­æ›‰</h3>`;
        players.forEach(p => {
            const evilRoles = ["åˆºå®¢", "è«ç”˜å¨œ", "çˆªç‰™", "è«å¾·é›·å¾·", "å¥§ä¼¯å€«"];
            let color = evilRoles.includes(p.role) ? "#ff6b6b" : "#82ccdd";
            html += `<div class="list-item">${p.name} - <span style="color:${color}">${p.role}</span></div>`;
        });
        
        const listDiv = document.getElementById("all-roles-reveal");
        listDiv.innerHTML = html;
        listDiv.classList.remove("hidden");
        
        // éš±è—æ­æ›‰æŒ‰éˆ•
        document.getElementById("btn-reveal-all").classList.add("hidden");
    }
</script>

</body>
</html>